<script setup>
// External libs
import { computed, onMounted } from 'vue';
import { storeToRefs } from 'pinia';
import { useRouter } from 'vue-router';
import { useQuizStore } from '@/stores/quizStore';

// Internal composables
import { useAuth } from '@/use/useAuth';
import { useStorage } from '@/use/useStorage';
import { useToast } from '@/use/useToast';

// UI Components
import Container from '@/components/Container.vue';
import Heading from '@/components/Heading.vue';
import UserStats from '@/components/UserStats.vue';
import Avatar from '@/components/Avatar.vue';
import Text from '@/components/Text.vue';
import QuizCard from '@/components/QuizCard.vue';
import Loader from '@/components/Loader.vue';
import Actions from '@/components/Actions.vue';
import Toast from '@/components/Toast.vue';

// Router & stores
const router = useRouter();
const quizStore = useQuizStore();
const { logOut } = useAuth();
const { removeStorage } = useStorage();
const { toast, toastData, handleToast } = useToast();
const { user, quizzes, isLoading, totalScore, completedCount } = storeToRefs(quizStore);

const firstName = computed(() => {
  return user.value?.name?.split(' ')[0] || 'Visitante';
});

const signOut = async () => {
  const response = await logOut();
  if (response.status === 'success') {
    removeStorage('user');
    router.push('/signin');
  }
};

onMounted(async () => {
  await quizStore.fetchAllQuizzesWithScores();
});
</script>

<template>
  <Container>
    <div
      v-if="isLoading"
      class="fixed inset-0 z-50 flex items-center justify-center bg-white/80"
    >
      <Loader color="primary" />
    </div>

    <div class="flex justify-between items-center w-full mb-5">
      <div class="flex flex-col items-start">
        <Heading
          size="lg"
          :text="`ðŸ‘‹ OlÃ¡ ${firstName},`"
        />

        <Text
          text="Ã‰ bom vÃª-lo novamente!"
          class="text-center mt-1"
        />
      </div>

      <Avatar :image="user?.image" />
    </div>

    <UserStats
      v-if="!isLoading"
      :points="totalScore || 0"
      :ranking="32" 
    />

    <Text
      v-if="!isLoading && !quizzes.length"
      class="mx-auto my-7"
      text="Nenhum quizz disponÃ­vel ainda :("
      size="md"
    />

    <div
      v-if="!isLoading && quizzes.length"
      class="quizzes flex flex-1 flex-col items-start w-full gap-3 my-7"
    >
      <QuizCard
        v-for="(quiz, index) in quizzes"
        :key="index"
        :quiz="quiz"
      />
    </div>

    <Actions
      v-if="!isLoading"
      class="mt-5"
      text-left="Sair"
      text-right="Ranking"
      @on-handle-left="signOut"
      @on-handle-right="router.push('/ranking')"
    />
    
    <Toast
      ref="toast"
      :toast-data="toastData"
    />
  </Container>
</template>
